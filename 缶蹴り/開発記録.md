# 缶蹴りゲーム 開発記録

## 現在の状態

### 完了済み

#### ステージ準備
- [x] 建物の高さ調整（8個の建物を地面Y=0に合わせた）
- [x] モンスター無効化（HorrorGameManager を Disabled = true）
- [x] 軽量化実施
  - ライト: 203個 → 14個（建物内ライト無効化、街灯半分無効化）
  - エフェクト: 75個 → 0個（全て無効化）
  - スクリプト: 140個 → 9個（モデル付属スクリプト110個無効化）

#### フェーズ1: 基盤システム
- [x] フォルダ構造作成
- [x] GameConfig（設定モジュール）作成
- [x] RoundManager（ラウンド管理）作成
- [x] GameController（メインスクリプト）作成
- [x] RemoteEvents作成（14個）

#### フェーズ2: コアオブジェクト
- [x] HP地点（缶の代替）実装
  - HPPointManager モジュール作成
  - GoalPositionsからランダム配置
  - ProximityPromptで攻撃可能
  - 10秒クールダウン（ビジュアル表示付き）
  - **火の玉/魂ビジュアル「魂の炎」に更新済み**
  - **出現位置を道路上に限定（建物との重複防止）**
- [x] 安全ゾーン実装
  - SafeZoneManager モジュール作成
  - HP地点から30スタッド以上離れた場所に出現
  - 10秒滞在で消滅→2秒後に別位置へ再出現
  - 緑の光る円柱＋ForceFieldエフェクト
  - 滞在時間カウントダウン表示
- [x] GameController更新（フェーズ2統合）

#### レベル・ダメージシステム
- [x] GameConfigにレベルシステム追加
  - Player Lv1-5: 攻撃力 50/75/100/130/165
  - Enemy Lv1-5: HP 100/200/350/550/800
  - 拡張可能な設計
- [x] OniHPManager作成
  - 鬼HP管理（ダメージ計算、勝利判定）
  - レベルに応じた攻撃力取得
  - Init() / Setup(lvl) / GetAttack(lvl) / Damage(dmg, name)
- [x] HPPointManager修正
  - OniHPManager統合
  - 攻撃時にダメージ計算
- [x] GameController修正
  - OniHPManager.Init() 追加
  - OniHPManager.Setup(1) をStartRoundで呼び出し

#### UI
- [x] 鬼HPゲージ（OniHPGui）
  - 画面上部中央に表示
  - HP減少アニメーション（TweenService）
  - 色変化（緑→黄→赤）
  - ダメージ時シェイク演出
  - HPContainer / HPBackground / HPBar / HPText / Title
  - HPBarController (LocalScript)
- [x] 勝利演出（VictoryGui）
  - "VICTORY!" テキスト
  - フェードイン/アウトアニメーション
  - 5秒後自動消滅
  - VictoryContainer / VictoryText / SubText
  - VictoryController (LocalScript)

#### 武器・攻撃システム
- [x] 剣（Sword）実装
  - StarterPackに配置
  - Grip設定修正（柄を持ち、剣先が上向き）
  - クリック/Eキーで攻撃可能
  - Slash/Lungeアニメーション交互再生
  - 0.5秒クールダウン
- [x] HP地点攻撃エフェクト（AttackEffectHandler）実装
  - StarterPlayerScriptsに配置
  - **HP地点の前でEキー（ProximityPrompt）で発動**
  - HP地点攻撃成功時のみエフェクトが出る
  - **素手と剣で演出分離 + R15アニメーション対応**

  **素手攻撃（パンチ）演出：**
  - R15パンチアニメーション
  - 前方ダッシュ + オレンジ残像
  - 巨大衝撃波（オレンジ）
  - 地面リング（黄色）
  - 火花パーティクル（オレンジ系）
  - フラッシュ（黄色）
  - 効果音（WHOOSH + IMPACT）

  **剣攻撃（斬撃）演出：**
  - R15斬撃アニメーション
  - 前方ダッシュ + 青白残像
  - 斬撃軌跡（青白い弧、二重）
  - 衝撃波（青）
  - スピードライン（青白）
  - 剣光粒子（青白）
  - フラッシュ（青白）
  - 効果音（SLASH + HIT）

#### フェーズ3: 鬼AI（実装完了）
- [x] OniAIモジュール作成
  - 状態マシン: PATROL / CHASE / STUNNED / RETURNING
  - ServerScriptService/KanKeri/Modules/OniAI
- [x] 巡回システム
  - PatrolPoints（6箇所）を順番に移動
  - 移動速度: MoveSpeed (24)
- [x] 索敵システム
  - 距離判定（DetectionRange: 50スタッド）
  - 視野角判定（FieldOfView: 120度）
  - Raycast遮蔽判定（壁越しは見えない）
- [x] 追跡システム
  - 最も近いプレイヤーを追跡（ChaseSpeed: 32）
  - 見失い猶予（LoseSightGracePeriod: 3秒）
  - 捕捉判定（4スタッド以内）
- [x] 追跡中断システム
  - HP地点攻撃で中断 → STUNNED状態へ
  - 安全ゾーン入りで中断
  - 弱体化（StunDuration: 3秒）後、HP地点へ帰還
- [x] 発見演出（「！」マーク）
  - DiscoveryEffectHandler (LocalScript)
  - プレイヤー頭上にBillboardGui表示
  - 赤い「！」マーク、0.5秒表示後フェードアウト
- [x] 鬼撃破演出
  - 鬼HP 0で空に吹っ飛ぶアニメーション
  - BodyVelocity + BodyAngularVelocity で回転しながら上昇
  - 3秒後にモデル消滅
  - Victory UIと連動
- [x] EnemyNPCHandler書き換え
  - OniAI.new()でインスタンス作成
  - RunService.Heartbeatでoni:Update(dt)呼び出し
- [x] HPPointManager統合
  - HP地点攻撃時にOniAI.OnHPPointAttacked()呼び出し
- [x] OniHPManager統合
  - 撃破時にactiveOni:PlayDefeatAnimation()呼び出し

---

### 要確認事項

#### GameConfig Levelシステム
- GameConfigにLevelテーブルを追加したが、Roblox Studioでrequireキャッシュの影響で反映されていない可能性あり
- **対処法**: Roblox Studioを再起動するか、プレイモードを一度実行してキャッシュをクリアする

---

## Roblox Studio 構造（2024/1/11更新）

```
Workspace/
├── Map/
│   ├── Buildings/ (22 items)
│   │   ├── AbandonedBuilding_01〜04
│   │   ├── AbandonedHouse_01〜08
│   │   ├── Building_01〜04
│   │   ├── OfficeBuilding_01〜03
│   │   └── LargeStructure_01〜03
│   ├── Props/ (5 items)
│   └── Vehicles/ (5 items)
│       └── PoliceCar_01〜05
├── Enemy/
│   └── Enemy NPC (鬼) - EnemyNPCHandler統合
├── PatrolPoints/ (12 items) - 鬼の巡回ルート
├── GoalPositions/ (10 items) - HP地点/安全ゾーン候補
└── HPPoints/ (ランタイム生成)

ServerScriptService/
├── KanKeri/
│   ├── Modules/
│   │   ├── OniAI (v5) - 鬼AI（状態マシン）
│   │   ├── OniHPManager - 鬼HP管理
│   │   ├── HPPointManager - HP地点管理
│   │   ├── SafeZoneManager - 安全ゾーン管理
│   │   └── RoundManager - ラウンド管理
│   └── Controllers/
│       ├── GameController - メインスクリプト
│       └── PoliceLightFlash - パトカーライト演出
└── Legacy/
    └── HorrorGameManager - 未使用（旧システム）

ReplicatedStorage/
├── KanKeri/
│   ├── Config/
│   │   └── GameConfig - ゲーム設定値
│   ├── Modules/
│   │   ├── EffectLibrary - 共通エフェクト関数
│   │   └── AttackConfig - 攻撃エフェクト設定
│   └── Events/ (17 RemoteEvents)
│       ├── RoundStateChanged, RoundCountdown, RoundStarted, RoundEnded
│       ├── OniHPChanged, OniStateChanged, OniDiscoveredPlayer, OniWarning, OniDefeated
│       ├── PlayerHPChanged, PlayerDied, PlayerRevived
│       ├── HPPointCooldownUpdate, RequestAttackHPPoint
│       ├── RequestRevive, RequestStartRound
│       └── PlayAttackEffect
└── Legacy/
    └── Monsters/ - 未使用（旧モンスター）

StarterPlayer/
└── StarterPlayerScripts/
    ├── AttackEffectHandler - HP地点攻撃エフェクト
    ├── DiscoveryEffectHandler - 発見演出（！マーク）
    └── OniWarningHandler - 警告UI

StarterGui/
├── OniHPGui - 鬼HPゲージ
│   ├── HPContainer / HPBackground / HPBar / HPText / Title
│   └── HPBarController (LocalScript)
└── VictoryGui - 勝利演出
    ├── VictoryContainer / VictoryText / SubText
    └── VictoryController (LocalScript)

StarterPack/
└── Sword (Tool)
    ├── SwordController (LocalScript)
    ├── SlashAnimation / LungeAnimation
    └── Handle (Part)
```

---

## 次のタスク

### フェーズ3: 鬼AI ✅ 完了（修正済み）

#### 修正履歴
| # | 問題 | 原因 | 対応 | 状態 |
|---|------|------|------|------|
| 1 | プレイヤー捕捉時ダメージなし | イベント参照エラー | Humanoid.Health=0 | ✅ |
| 2 | 怯み演出なし | 視覚効果未実装 | 灰色化+震え+パーティクル | ✅ |
| 3 | 「鬼が戻ってくるぞ！」なし | 未実装 | OniWarningHandler追加 | ✅ |
| 4 | 鬼が戻ってこない | RETURNING処理不備 | HP地点検索ロジック修正 | ✅ |
| 5 | 撃破時に消える | Velocity高+Destroy | 少し飛んで倒れる+残る | ✅ |
| 6 | 巡回範囲が狭い | PatrolPoints集中 | 12箇所に拡散 | ✅ |
| 7 | 速度が混在 | WalkSpeed未更新 | 各状態で明示設定 | ✅ |
- [ ] 発見演出（「！」マーク）
  - プレイヤー頭上にビルボード表示
  - 0.5秒表示後フェードアウト
- [ ] 鬼撃破演出
  - 鬼HP 0で空に吹っ飛ぶアニメーション
  - Victory UIと連動

### フェーズ4: プレイヤー
- [ ] プレイヤーHP（初期3、被ダメージ処理）
- [ ] 復帰システム（HP0→ダイヤ消費で復帰）

### フェーズ5: UI追加
- [ ] プレイヤーUI（HP、クールダウン、復帰ボタン）

### フェーズ6: マルチ対応
- [ ] HPスケーリング（人数に応じた鬼HP調整）

---

## 既存ステージのアセット（2024/1/11更新）

| フォルダ | 内容 | 数量 |
|----------|------|------|
| Map/Buildings | AbandonedBuilding_01〜04 | 4 |
| Map/Buildings | AbandonedHouse_01〜08 | 8 |
| Map/Buildings | Building_01〜04 | 4 |
| Map/Buildings | OfficeBuilding_01〜03 | 3 |
| Map/Buildings | LargeStructure_01〜03 | 3 |
| Map/Props | Structure_01〜02, Prop_01〜03 | 5 |
| Map/Vehicles | PoliceCar_01〜05 | 5 |
| PatrolPoints | P01〜P12 | 12 |
| GoalPositions | G1〜G10 | 10 |

---

## GoalPositions 配置（道路上・建物外）

| 名前 | X | Z | 場所 |
|------|---|---|------|
| GoalPoint1 | -120 | 90 | 十字路中心 |
| GoalPoint2 | -50 | 90 | 十字路から東 |
| GoalPoint3 | 0 | 90 | 中央道路 |
| GoalPoint4 | -120 | 0 | 南北道路（南） |
| GoalPoint5 | -120 | 180 | 南北道路（北） |
| GoalPoint6 | -50 | 0 | 南側十字路 |
| GoalPoint7 | -80 | 140 | 北西道路 |
| GoalPoint8 | -80 | 40 | 南西道路 |

## PatrolPoints 配置（道路上・建物外）

| 名前 | X | Z | 場所 |
|------|---|---|------|
| PatrolPoint1 | -120 | 90 | 十字路中心 |
| PatrolPoint2 | -70 | 90 | 十字路東側 |
| PatrolPoint3 | -20 | 90 | 中央寄り |
| PatrolPoint4 | -120 | 130 | 北方向 |
| PatrolPoint5 | -120 | 50 | 南方向 |
| PatrolPoint6 | -120 | 10 | 南端 |
| PatrolPoint7 | -120 | 170 | 北端 |
| PatrolPoint8 | -90 | 60 | 斜め |
| PatrolPoint9 | -60 | 120 | 斜め2 |
| PatrolPoint10 | -40 | 50 | 内側 |

---

## GameConfig 設定値

```lua
-- レベルシステム
Level.Player[1] = { AttackPower = 50 }
Level.Player[2] = { AttackPower = 75 }
Level.Player[3] = { AttackPower = 100 }
Level.Player[4] = { AttackPower = 130 }
Level.Player[5] = { AttackPower = 165 }

Level.Enemy[1] = { HP = 100 }   -- 2回で倒せる (50x2)
Level.Enemy[2] = { HP = 200 }
Level.Enemy[3] = { HP = 350 }
Level.Enemy[4] = { HP = 550 }
Level.Enemy[5] = { HP = 800 }

Level.DefaultPlayerLevel = 1
Level.DefaultEnemyLevel = 1

-- 鬼
Oni.BaseHP = 100
Oni.MoveSpeed = 24
Oni.ChaseSpeed = 32
Oni.DetectionRange = 50
Oni.FieldOfView = 120
Oni.LoseSightGracePeriod = 3
Oni.StunDuration = 3
Oni.HPScalingAlpha = 0.2

-- HP地点
HPPoint.AttackCooldown = 10
HPPoint.InteractionRange = 8  -- ProximityPrompt距離と統一

-- 安全ゾーン
SafeZone.MaxStayDuration = 10
SafeZone.MinDistanceFromHPPoint = 30
SafeZone.RespawnDelay = 2

-- プレイヤー
Player.MaxHP = 3
Player.ReviveHP = 1
Player.ReviveDiamondCost = 1
Player.MoveSpeed = 16
Player.BaseAttackPower = 10

-- ラウンド
Round.CountdownTime = 5
Round.TimeLimit = 0
Round.MinPlayersToStart = 1

-- デバッグ
Debug.Enabled = true
```

---

## 魂の炎（HP地点）ビジュアル調整メモ

今後調整する可能性があるパラメータ：

### 通常状態（攻撃可能）
| パーツ | プロパティ | 現在値 | 備考 |
|--------|------------|--------|------|
| SoulCore（外球） | Color | RGB(255, 150, 50) | オレンジ |
| SoulCore | Size | 3, 3, 3 | 球体サイズ |
| SoulCore | Transparency | 0.3 | |
| InnerCore（内核） | Color | RGB(255, 255, 200) | 明るい黄白 |
| InnerCore | Size | 1.5, 1.5, 1.5 | |
| Base（地面円） | Color | RGB(255, 100, 50) | |
| Base | Size | 直径8スタッド | |
| MainLight | Color | RGB(255, 150, 50) | |
| MainLight | Brightness | 3 | |
| MainLight | Range | 25 | |
| FireParticle | Rate | 30 | 火の粉の量 |
| AuraParticle | Rate | 10 | オーラの量 |

### クールダウン状態（攻撃不可）
| パーツ | プロパティ | 現在値 | 備考 |
|--------|------------|--------|------|
| SoulCore | Color | RGB(100, 120, 180) | 青系 |
| SoulCore | Transparency | 0.6 | より透明 |
| InnerCore | Color | RGB(150, 170, 220) | |
| Base | Color | RGB(80, 100, 150) | |
| MainLight | Brightness | 1 | 暗め |
| FireParticle | Rate | 5 | 少なめ |
| AuraParticle | Rate | 3 | 少なめ |
| ラベル | Text | "回復中..." | |

---

## 注意事項

- HorrorGameManagerはLegacyフォルダに移動（削除はしていない）
- 建物内ライト・エフェクトは無効化のみ（削除していない）
- デバッグモードON（プレイヤー参加3秒後に自動ラウンド開始）

---

## パトカーライト点滅

- **Sirenスクリプト**: 30個を無効化（エラー解消）
- **サウンド**: 20個を削除（アクセス権限エラー解消）
- **PoliceLightFlash**: KanKeri/Controllersに移動
  - G1ライト（青）とG2ライト（赤）が0.3秒間隔で交互に点滅
  - パトカー5台分のライトを自動検出

---

## 2024年1月11日 バグ修正＆リファクタリング

### 発見されたバグ

#### 1. 攻撃エフェクト消失問題
**症状**: HP地点を攻撃してもエフェクトが出ない、鬼がスタンしない、警告UIが出ない

**原因**: OniAIモジュールで静的関数とインスタンスメソッドが同名だった
```lua
function OniAI.OnHPPointAttacked(player)  -- 静的関数
function OniAI:OnHPPointAttacked()         -- インスタンスメソッド
-- Luaでは後者が前者を上書きしてしまう
```

**解決**: 静的関数を`HandleHPPointAttack`にリネーム

#### 2. 無限ループ / Path failedスパム
**症状**: 出力に大量のログ、Path failed: NoPath が毎秒60回以上

**原因**: パス計算失敗時のリトライが無制限

**解決**: `PathRetryTimer`を追加し、0.5秒間隔でリトライ

#### 3. HPゲージ→エフェクトの順序
**症状**: HPゲージが減ってからエフェクトが出る（違和感）

**原因**: `Damage()`の後に`PlayAttackEffect`を呼んでいた

**解決**: `PlayAttackEffect`を`Damage`の前に移動

### エクスプローラー構造リファクタリング

**実施内容**:
1. Workspace整理
   - `Map/Buildings/` - 建物を整理（22個）
   - `Map/Props/` - プロップを整理（5個）
   - `Map/Vehicles/` - 車両を整理（PoliceCar_01〜05）
   - 「Model」という名前を全てリネーム
   - 「Builidng」のタイポを修正

2. ServerScriptService整理
   - `HorrorGameManager`を`Legacy/`に移動
   - `PoliceLightFlash`を`KanKeri/Controllers/`に移動

3. ReplicatedStorage整理
   - 空の`Events`フォルダを削除
   - `Monsters`を`Legacy/`に移動

4. OniAIリファクタリング
   - v4 → v5にアップグレード
   - モジュール構造ガイドコメントを追加
   - `GetActiveOni()`関数を追加
   - デバッグログを削除

**構造評価スコア**: 52点 → 79点

### 残課題
- 鬼がHP地点に戻らない場合がある（RETURNING状態の調査必要）
