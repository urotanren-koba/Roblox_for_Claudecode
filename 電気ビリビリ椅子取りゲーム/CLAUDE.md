# 電気ビリビリ椅子取りゲーム - CLAUDE.md

まず、実装する際には必ず守ってほしい共通ルール
・スクリプトのコーディング実装や、実際にモデルなどアセットを使用する際は拡張性、可読性、保守性、可用性などプロのエンジニアが実装するコードがロジックを元に開発すること

## プロジェクト概要

最大10人（不足分はNPCで補填）で対戦する運ゲー形式の椅子取りゲーム。
各ラウンドで電気椅子を引いた人が脱落し、最後まで生き残った1名が勝者となる。

---

## 拡張性設計（人数スケーリング）

プレイヤー数に応じて、1ラウンドあたりの脱落者数が変動する。

### 計算式
```lua
-- 電気椅子の数（= 1ラウンドの脱落者数）
local eliminationCount = math.max(1, math.floor(totalPlayers / 10))
```

### スケーリング例
| プレイヤー数 | 電気椅子の数 | 1ラウンド脱落者 | 必要ラウンド数 |
|-------------|-------------|----------------|---------------|
| 10人 | 1個 | 1人 | 9ラウンド |
| 20人 | 2個 | 2人 | 10ラウンド |
| 30人 | 3個 | 3人 | 10ラウンド |
| 15人 | 1個 | 1人 | 14ラウンド |
| 25人 | 2個 | 2人 | 12ラウンド |

### 実装上の注意
- 椅子数 = 生存者数（従来通り）
- 電気椅子は複数個がランダムに選ばれる
- 最終ラウンド（生存者が電気椅子数+1以下）では電気椅子を1個に減らす
- 例: 20人制で残り3人 → 電気椅子1個（2人だと全滅するため）

```lua
-- 最終ラウンド調整
local survivors = getAliveCount()
local baseElimination = math.floor(totalPlayers / 10)
local actualElimination = math.min(baseElimination, survivors - 1)
actualElimination = math.max(1, actualElimination) -- 最低1人は脱落
```

---

## ラウンド進行フロー（確定仕様）

```
┌─────────────────────────────────────────────────────────────┐
│  1. 音楽スタート                                              │
│     - BGMが流れ始める                                         │
│     - プレイヤー/NPCは椅子の周りを自由に移動                    │
├─────────────────────────────────────────────────────────────┤
│  2. 音楽ストップ                                              │
│     - BGMが突然止まる（ランダム時間 10〜20秒後）                 │
│     - 「椅子を選べ！」の合図                                   │
├─────────────────────────────────────────────────────────────┤
│  3. 椅子選択フェーズ（制限時間あり）                            │
│     - プレイヤーは好きな椅子をクリック/タップして選択            │
│     - NPCも同時にランダムで椅子を選択                          │
│     - 制限時間内に選ばなかった人はサーバーがランダム割当         │
├─────────────────────────────────────────────────────────────┤
│  4. 着席＆衝突解決                                            │
│     - 同じ椅子を選んだ場合→1人当選、他は空き椅子へランダム割当   │
│     - 全員が1つの椅子に確定して座る                            │
├─────────────────────────────────────────────────────────────┤
│  5. カウントダウン（5秒）                                      │
│     - 全員着席後、画面に「5... 4... 3... 2... 1...」表示        │
│     - 緊張感を演出                                            │
├─────────────────────────────────────────────────────────────┤
│  6. 電気椅子判定＆ビリビリ演出                                  │
│     - カウント0で電気椅子が発動                                │
│     - 電気椅子に座っていた人がビリビリ演出で吹っ飛ぶ             │
│     - 脱落者は観戦席へ移動 or 退出                             │
├─────────────────────────────────────────────────────────────┤
│  7. 次ラウンド準備                                            │
│     - 椅子を1つ減らす（生存者数 = 椅子数）                      │
│     - 生存者が1人になるまで繰り返し                            │
└─────────────────────────────────────────────────────────────┘
```

### タイミング設計
| フェーズ | 時間 |
|---------|------|
| 音楽再生 | 10〜20秒（ランダム） |
| 椅子選択 | 5〜8秒 |
| 着席演出 | 2秒 |
| カウントダウン | 5秒 |
| ビリビリ演出 | 3秒 |
| 次ラウンド準備 | 2秒 |
| **1ラウンド合計** | **約27〜40秒** |

---

## 要件定義の評価

### 良い点

1. **サーバー権威型設計** - 電気椅子IDをクライアントに送信しない、座席割当をサーバーで確定するなど、チート対策が適切
2. **明確な状態遷移** - ステートマシンで進行を管理しており、実装しやすい
3. **衝突解決の仕様が明確** - 同じ椅子を選んだ場合のランダム割当ルールが定義済み
4. **NPC補填システム** - 少人数でもゲームが成立する設計

### 追加演出案

#### 1. 椅子配置の工夫
```
- 円形配置で毎ラウンド椅子が中心に寄る（ステージが狭くなる感覚）
- または椅子の見た目が徐々に不気味になる演出
```

#### 2. 観戦機能の強化
```
- 観戦者が次の電気椅子を予想する「賭け」システム（報酬に影響）
- 観戦者が生存者を応援できるエモート
```

## 推奨フォルダ構成

```
電気ビリビリ椅子取りゲーム/
├── CLAUDE.md
├── ゲーム要件.md
└── src/
    ├── ServerScriptService/
    │   ├── GameManager.server.lua      -- メインゲーム制御
    │   ├── RoundController.lua         -- ラウンド進行モジュール
    │   ├── MatchmakingService.lua      -- ルーム・マッチング
    │   ├── NPCController.lua           -- NPC生成・制御
    │   └── SeatAssigner.lua            -- 座席割当・衝突解決
    ├── ReplicatedStorage/
    │   ├── Remotes/
    │   │   ├── JoinRoom.lua            -- ルーム参加
    │   │   ├── LeaveRoom.lua           -- ルーム退出
    │   │   ├── SelectSeat.lua          -- 椅子選択
    │   │   └── RequestSpectate.lua     -- 観戦リクエスト
    │   ├── GameState.lua               -- 共有ゲーム状態
    │   └── Constants.lua               -- 定数定義
    ├── StarterPlayerScripts/
    │   └── GameClient.client.lua       -- クライアント処理
    └── StarterGui/
        ├── RoomSelectUI/               -- ルーム選択画面
        ├── GameHUD/                    -- ゲーム中UI
        ├── SeatSelectUI/               -- 椅子選択UI
        └── ResultUI/                   -- 結果表示UI
```

## RemoteEvent設計

### クライアント→サーバー
| Remote名 | 用途 | パラメータ |
|---------|------|-----------|
| JoinRoom | ルーム参加 | roomId: string |
| LeaveRoom | ルーム退出 | なし |
| SelectSeat | 椅子選択 | seatId: number |
| RequestSpectate | 観戦リクエスト | なし |
| RequestExit | 退出リクエスト | なし |

### サーバー→クライアント
| Remote名 | 用途 | パラメータ |
|---------|------|-----------|
| RoomUpdate | ルーム状態更新 | roomData: table |
| MatchStart | マッチ開始 | participants: table |
| MusicStart | 音楽開始 | roundIndex: number |
| MusicStop | 音楽停止（椅子選択開始） | timeLimit: number |
| SeatConfirmed | 座席確定通知 | assignments: table |
| CountdownStart | カウントダウン開始 | seconds: number |
| Elimination | 脱落通知（ビリビリ演出） | eliminatedId, dangerSeatId |
| GameEnd | ゲーム終了 | winnerId, rewards |
| TeleportTo | テレポート指示 | destination: string |

## 主要な実装ポイント

### 1. 椅子割当アルゴリズム（SeatAssigner）
```lua
-- 衝突解決の流れ
-- 1. 各参加者の希望を集計
-- 2. 同じ椅子を希望した人がいれば、1人をランダムで当選
-- 3. 外れた人は空き椅子にランダム割当
-- 4. 未選択者も空き椅子にランダム割当
-- 5. 結果: 全員が必ず異なる椅子に座る
```

### 2. ラウンド制御（RoundController）
```lua
-- 状態遷移:
-- MusicPlay → MusicStop → SeatPick → SeatAssign → Countdown → Elimination → Cleanup
--
-- MusicPlay: BGM再生（10〜20秒ランダム）
-- MusicStop: 音楽停止、「椅子を選べ！」表示
-- SeatPick: 椅子選択受付（5〜8秒）
-- SeatAssign: 衝突解決、全員着席
-- Countdown: 5秒カウントダウン
-- Elimination: 電気椅子発動、ビリビリ演出
-- Cleanup: 脱落者処理、次ラウンド準備
```

### 3. NPC行動
```lua
-- NPCは選択フェーズ開始から2-5秒後にランダムで椅子を選択
-- プレイヤーと同じロジックで座席割当
```

## ゲームバランス検討

### 1ゲームの想定時間
- 10人→1人: 9ラウンド
- 1ラウンド: 約20-30秒（選択10秒 + 演出10-20秒）
- 合計: 約3-5分

### 報酬設計案
| 順位 | 報酬 |
|------|------|
| 1位（勝者） | 100コイン |
| 2-3位 | 50コイン |
| 4-5位 | 30コイン |
| 6-10位 | 10コイン |
| 参加のみ | 5コイン |

## 追加検討事項

1. **再戦機能** - ゲーム終了後に同じメンバーで再戦できるか
2. **パーティ機能** - 友達と一緒のルームに入れるか
3. **デイリーチャレンジ** - 「3回勝利」など継続プレイ促進
4. **椅子スキン** - カスタマイズ要素（課金ポイント）
5. **サウンド演出** - BGM変化、ビリビリ音、歓声など

## 開発優先順位

### Phase 1: MVP（最小限のプレイ可能版）
1. 基本ステージ（椅子配置）
2. 座席選択・割当システム
3. 電気椅子判定・脱落処理
4. 勝者決定

### Phase 2: マッチング
1. ルーム選択UI
2. マッチングロジック
3. NPC補填

### Phase 3: 演出・UI
1. ビリビリ演出
2. 結果表示
3. 観戦機能

### Phase 4: ポリッシュ
1. 報酬システム
2. サウンド
3. エフェクト強化

## ビルド・テストコマンド

```bash
# Rojo同期（開発時）
rojo serve

# プレイテスト
# Roblox Studioで直接実行

# Luau型チェック（推奨）
# Studio内のScript Analysisを使用
```

## 注意事項

- 電気椅子IDは絶対にクライアントに事前送信しない
- すべての座席割当・脱落判定はサーバーで行う
- タイムアウト処理を必ず実装（無限待機防止）
- NPC削除時はイベント解除を忘れずに（メモリリーク防止）
