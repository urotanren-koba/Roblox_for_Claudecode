# マラソンゲーム 仕様書

最終更新: 2026年1月5日

---

## 概要

東京都をモチーフにしたマラソンレースゲーム。プレイヤーは29体のCPUランナーと競い合い、コース上のスピードコインを取得しながらゴールを目指す。ベストタイムは自動保存され、世界ランキングで他プレイヤーと競える。

### 基本情報

| 項目 | 値 |
|------|-----|
| プレイス名 | ISLAND MARATHON |
| PlaceId | 114432144948325 |
| GameId | 9487296854 |
| 最大レーサー数 | 30 (プレイヤー1 + CPU29) |
| CPU数 | 29体 |
| 周回数 | 1周 |

---

## ゲームフロー

```
[LOBBY] → [DIFFICULTY SELECT] → [COUNTDOWN] → [RACING] → [FINISHED] → [RESULTS]
   ↑                                                                       |
   └───────────────────────────────────────────────────────────────────────┘
```

### 状態遷移

| 状態 | 値 | 説明 |
|------|-----|------|
| LOBBY | 1 | 待機中。プレイヤーはスポーン地点に制限される |
| COUNTDOWN | 2 | カウントダウン中 (5秒) |
| RACING | 3 | レース中 |
| FINISHED | 4 | ゴール済み |
| RESULTS | 5 | 結果表示 |

---

## コースシステム

### コース構成

| 項目 | 値 |
|------|-----|
| 総ウェイポイント数 | 348 |
| 左ポール数 | 363 |
| 右ポール数 | 367 |
| スタートポール番号 | 224 |
| ゴールポール番号 | 223 |
| コース平均幅 | 約46ユニット |

### ウェイポイント生成

コース順序は**貪欲法（Greedy Algorithm）**で自動生成される:

1. スタートポール (224) から開始
2. 最も近い未訪問ポールを次のウェイポイントとして選択
3. 最大距離閾値 (100ユニット) 以内のポールのみ対象
4. 全ポールを訪問するまで繰り返し

```lua
-- CPUCourseData.lua より
local MAX_DISTANCE = 100
while true do
    local nearestPole = nil
    local nearestDist = math.huge
    for _, poleNum in ipairs(availablePoles) do
        if not visited[poleNum] then
            local dist = (thisMid - currentMid).Magnitude
            if dist < nearestDist and dist < MAX_DISTANCE then
                nearestDist = dist
                nearestPole = poleNum
            end
        end
    end
    -- 最も近いポールを次のウェイポイントに
end
```

### ポール命名規則

```
ポール_L_補強A_[番号]  -- 左ポール
ポール_R_補強A_[番号]  -- 右ポール
```

ウェイポイントの中心点は左右ポールの中間位置として計算される。

---

## プレイヤーシステム

### 速度設定

| 状態 | 速度 (WalkSpeed) |
|------|------------------|
| 通常 | 16 |
| ブースト中 | 32 |

### 進捗検出パラメータ

| パラメータ | 値 | 説明 |
|------------|-----|------|
| DETECTION_RADIUS | 30 | ウェイポイント検出半径 |
| LOOK_AHEAD_COUNT | 50 | 先読みウェイポイント数 |

**重要**: プレイヤーは手動操作のため、CPU (MoveTo使用) とは異なる検出ロジックを使用。コース幅 (約46ユニット) の半分以上をカバーする検出半径が必要。

### スポーン制限

- ロビー状態ではスポーン地点から半径50ユニット以内に制限
- 制限外に出ると自動的にスポーン地点に戻される

---

## 難易度システム

### 難易度選択

レース開始前に3つの難易度から選択可能:

| 難易度 | 色 | CPUレベル | 説明 |
|--------|-----|----------|------|
| EASY | 緑 (RGB: 80, 200, 120) | 全員レベル3 | 初心者向け |
| NORMAL | 青 (RGB: 100, 150, 255) | レベル3〜5ランダム | バランス型 |
| HIGH | 赤 (RGB: 255, 80, 80) | 全員レベル5 | 上級者向け |

### 難易度による違い

| 難易度 | CPU基本速度 | CPUブースト速度 | 勝ちやすさ |
|--------|-------------|-----------------|-----------|
| EASY | 14 | 24 | 勝ちやすい |
| NORMAL | 14〜18 | 24〜32 | 普通 |
| HIGH | 18 | 32 | 難しい |

### 実装詳細

```lua
-- DifficultyConfig.lua (ReplicatedStorage/RaceShared/Modules)
DifficultyConfig.Settings = {
    [1] = {Name="EASY", CPUMin=3, CPUMax=3},   -- 全員レベル3
    [2] = {Name="NORMAL", CPUMin=3, CPUMax=5}, -- レベル3-5ランダム
    [3] = {Name="HIGH", CPUMin=5, CPUMax=5},   -- 全員レベル5
}
```

---

## CPUシステム

### 基本設定

| 項目 | 値 |
|------|-----|
| CPU数 | 29体 |
| レベル範囲 | 3〜5 (難易度により変動) |
| アニメーション | R6走りアニメーション |

### レベル設定

| レベル | 名前 | 基本速度 | ブースト速度 | 特徴 |
|--------|------|----------|--------------|------|
| 3 | Normal | 14 | 24 | 標準的な動き |
| 4 | Hard | 16 | 28 | より速く正確 |
| 5 | Expert | 18 | 32 | 最高性能 |

### レベル別詳細パラメータ

#### Level 3 (Normal)
```lua
{
    BaseSpeed = 14,
    BoostSpeed = 24,
    PathAccuracy = 0.6,
    SpeedVariation = 0.15,
    ReactionTime = 0.5,
    JumpTiming = 0.6,
    CoinDetectRange = 15,
    CoinPriority = 0.4,
    SlowdownChance = 0.08
}
```

#### Level 4 (Hard)
```lua
{
    BaseSpeed = 16,
    BoostSpeed = 28,
    PathAccuracy = 0.75,
    SpeedVariation = 0.1,
    ReactionTime = 0.3,
    JumpTiming = 0.75,
    CoinDetectRange = 22,
    CoinPriority = 0.6,
    SlowdownChance = 0.05
}
```

#### Level 5 (Expert)
```lua
{
    BaseSpeed = 18,
    BoostSpeed = 32,
    PathAccuracy = 0.85,
    SpeedVariation = 0.05,
    ReactionTime = 0.1,
    JumpTiming = 0.85,
    CoinDetectRange = 30,
    CoinPriority = 0.8,
    SlowdownChance = 0.02
}
```

### CPUカスタマイズシステム

各CPUは個別の見た目を持つ:

| 項目 | 内容 |
|------|------|
| 名前 | 30種類のユニーク名 (Takeshi, Yuki, Sakura等) |
| 肌色 | 6種類からランダム |
| 服の色 | 10種類からランダム |
| パンツ色 | 6種類からランダム |
| 顔 | 5種類からランダム |

```lua
-- CPUCustomizer.lua
local NAMES = {
    "Takeshi", "Yuki", "Haruto", "Sakura", "Ren", "Aoi", "Sota", "Hana",
    "Kaito", "Mio", "Riku", "Yuna", "Hayate", "Mei", "Daiki", "Koharu",
    "Shota", "Hinata", "Kenji", "Akari", "Tsubasa", "Rin", "Yuto", "Saki",
    "Kenta", "Nana", "Ryota", "Ayaka", "Shin", "Momoka"
}
```

### CPUアニメーション

- R6走りアニメーション (rbxassetid://180426354)
- 速度に応じてアニメーション速度自動調整
- レース開始時に再生、ゴール時に停止

### CPU AI動作

1. **MoveTo** でウェイポイント中心に向かって移動
2. ウェイポイントから8ユニット以内で次のウェイポイントへ
3. 障害物検出時にジャンプ
4. レーン内でのウェービング動作 (自然な動きを演出)

---

## スピードコインシステム

### コイン種類

| 種類 | 色 | 出現数 | ブースト時間 |
|------|-----|--------|--------------|
| Blue | 青 (RGB: 50, 150, 255) | 50個 | 3秒 |
| Yellow | 黄 (RGB: 255, 220, 50) | 30個 | 5秒 |
| Red | 赤 (RGB: 255, 50, 50) | 10個 | 10秒 |

### コイン仕様

- 形状: 円筒形 (Cylinder)
- サイズ: 0.5 x 4 x 4
- 素材: Neon (発光)
- 回転アニメーション付き
- リスポーン時間: 3秒

### コイン配置

ポールペア間のランダムな位置に配置:
```lua
local t = math.random(30, 70) / 100  -- 30%〜70%の位置
local x = pair.left.X + (pair.right.X - pair.left.X) * t
local z = pair.left.Z + (pair.right.Z - pair.left.Z) * t
local y = getGroundY(x, z) + 3
```

---

## ハザードシステム

### ハザードシールド

- 総数: 730個
- 触れるとペナルティ発生
- ペナルティ: 3秒間停止後、最寄りのコース中央にリスポーン
- ブースト状態は解除される

---

## 順位システム (RankingManager)

### 順位計算方式 (マリオカート方式)

優先順位:
1. **ゴール済みを優先** (タイム順)
2. **周回数** (多い方が上位)
3. **チェックポイント** (進んでいる方が上位)
4. **次のチェックポイントへの距離** (近い方が上位)

```lua
table.sort(sorted, function(a, b)
    -- 1. ゴール済み優先
    if a.status == FINISHED and b.status == FINISHED then
        return a.finishTime < b.finishTime
    elseif a.status == FINISHED then
        return true
    elseif b.status == FINISHED then
        return false
    end

    -- 2. 周回数
    if a.currentLap ~= b.currentLap then
        return a.currentLap > b.currentLap
    end

    -- 3. チェックポイント
    if a.currentWaypoint ~= b.currentWaypoint then
        return a.currentWaypoint > b.currentWaypoint
    end

    -- 4. 距離
    return a.distanceToNext < b.distanceToNext
end)
```

### レーサーステータス

| ステータス | 説明 |
|------------|------|
| Waiting | 待機中 |
| Ready | 準備完了 |
| Racing | レース中 |
| Finished | ゴール済み |
| DNF | 未完走 |
| DQ | 失格 |

---

## データ保存・ランキングシステム

### 概要

| 機能 | 説明 |
|------|------|
| ベストタイム保存 | プレイヤーごとに自動保存 |
| 世界ランキング | OrderedDataStoreで管理 |
| キャッシュ | 30秒間キャッシュで負荷軽減 |
| レート制限 | 2秒間隔でリクエスト制限 |

### データ構造

```lua
-- プレイヤーデータ (DataStore: MarathonPlayerData_v1)
{
    bestTime = 123.456,    -- ベストタイム (秒)
    totalRaces = 10,       -- 総レース回数
    lastPlayed = os.time() -- 最終プレイ日時
}

-- ランキング (OrderedDataStore: MarathonRanking_v1)
-- Key: "Player_[UserId]"
-- Value: ベストタイム (ミリ秒、整数)
```

### 動作フロー

```
ゴール時:
1. MarathonServer: finishTime計算
2. TimeDataManager.SaveBestTime(player, finishTime)
   - 既存ベストと比較
   - 新記録なら DataStore + OrderedDataStore に保存
   - 新記録でなければ totalRaces のみ更新

ランキング表示時:
1. クライアント: GetRankingData:InvokeServer()
2. RankingServer: TimeDataManager.GetWorldRanking(50)
   - キャッシュ確認 (30秒有効)
   - キャッシュなければ OrderedDataStore から取得
3. クライアント: ランキングUI更新
```

### 必要な設定

- ゲームをRobloxにPublish済み
- Game Settings > Security > 「StudioのAPIサービスへのアクセスを有効化」をON

---

## UI システム

### ホーム画面

| 要素 | 説明 |
|------|------|
| タイトル | "ISLAND MARATHON" |
| START RACEボタン | 難易度選択画面へ (緑) |
| RANKINGボタン | ランキング画面へ (オレンジ) |

### 難易度選択画面

| 要素 | 説明 |
|------|------|
| タイトル | "SELECT DIFFICULTY" |
| EASYボタン | 初心者向け (緑) |
| NORMALボタン | バランス型 (青) |
| HIGHボタン | 上級者向け (赤) |
| BACKボタン | ホーム画面に戻る (グレー) |

### レース中UI

| 要素 | 位置 | 説明 |
|------|------|------|
| タイマー | 右上 | 経過時間表示 |
| 自分の順位 | 上部中央 | "X / 30" 形式 |
| リーダーボード | 左側 | 上位10名 + 自分 |

### ランキング画面

| 要素 | 説明 |
|------|------|
| YOUR STATS | 自分のベストタイム + 世界順位 |
| WORLD RANKING | 上位50名のリスト |
| BACKボタン | ホーム画面に戻る |

### フィニッシュ画面

| 要素 | 説明 |
|------|------|
| RACE COMPLETE! | 完走メッセージ |
| 順位表示 | "1st Place" 等 |
| タイム表示 | 完走タイム |
| TRY AGAINボタン | ホーム画面に戻る |

### モバイル対応

デバイス判定:
```lua
local UserInputService = game:GetService("UserInputService")
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
```

| 要素 | PC | モバイル |
|------|-----|---------|
| リーダーボード幅 | 280px | 160px |
| リーダーボード高さ | 350px | 200px |
| エントリ高さ | 28px | 22px |
| 順位幅 | 38px | 24px |
| 名前幅 | 120px | 55px |
| 進捗幅 | 60px | 40px |
| タイプアイコン | 表示 | 非表示 |

---

## モジュール構成

### サーバーサイド

```
ServerScriptService/
├── MarathonServer.lua    -- メインレースサーバー
├── CPUManager.lua        -- CPU制御
└── RankingServer.lua     -- ランキングデータ提供

ServerStorage/
├── RaceSystem/
│   ├── Config/
│   │   └── RaceConfig.lua       -- レース設定
│   └── Modules/
│       ├── RankingManager.lua   -- 順位管理
│       ├── CheckpointManager.lua -- チェックポイント管理
│       ├── RaceController.lua   -- レース制御
│       └── TimeDataManager.lua  -- タイム保存・ランキング
└── CPUCharacters/
    ├── CPUConfig.lua     -- CPU設定
    ├── CPUCourseData.lua -- コースデータ
    ├── CPUAI.lua         -- CPU AI (アニメーション対応)
    ├── CPUCustomizer.lua -- CPUカスタマイズ
    └── CPURunner (Model) -- CPUキャラクターテンプレート
```

### 共有 (ReplicatedStorage)

```
ReplicatedStorage/
└── RaceShared/
    ├── Modules/
    │   ├── RankingUIData.lua
    │   └── DifficultyConfig.lua  -- 難易度設定
    └── Events/
        ├── StartRace           -- レース開始 (難易度パラメータ付き)
        ├── RaceFinished        -- レース終了
        ├── UpdateTimer         -- タイマー更新
        ├── UpdatePositions     -- 位置更新
        ├── UpdateRankings      -- 順位更新
        ├── DifficultySelected  -- 難易度選択完了 (BindableEvent)
        ├── GetRankingData      -- ランキング取得 (RemoteFunction)
        └── GetPlayerStats      -- プレイヤー統計取得 (RemoteFunction)
```

### クライアントサイド

```
StarterGui/
└── MarathonClient/
    ├── ClientScript.lua       -- UI制御 (ランキングUI含む)
    └── DifficultySelector.lua -- 難易度選択UI
```

---

## イベントフロー

### レース開始時

```
1. Player: START RACEボタン押下
   ↓
2. DifficultySelector: 難易度選択画面表示
   ↓
3. Player: 難易度選択 (EASY/NORMAL/HIGH)
   ↓
4. DifficultySelector: DifficultySelected:Fire(difficulty)
   ↓
5. ClientScript:
   - DifficultySelected.Event 受信
   - カウントダウン表示 (5,4,3,2,1,GO!)
   - StartRace:FireServer(difficulty)
   ↓
6. CPUManager:
   - CleanupCPUs() - 全レーサークリア
   - 難易度に応じたCPUレベル設定
   - 29体のCPUをスポーン＆カスタマイズ＆登録
   - RankingManager.StartRace()
   ↓
7. MarathonServer (task.defer):
   - プレイヤー状態を強制リセット
   - task.wait(0.1) でCPUManager同期
   - プレイヤーを登録
   - プレイヤーをRACING状態に
```

### レース中 (Heartbeat)

```
毎フレーム:
├── MarathonServer:
│   - プレイヤーの位置チェック
│   - ウェイポイント通過判定
│   - RankingManager.UpdateProgress()
│   - タイマー更新をクライアントに送信
│
├── CPUManager:
│   - 全CPUの位置チェック
│   - RankingManager.UpdateProgress()
│
└── RankingManager:
    - CalculateRankings()
    - BroadcastRankings() → クライアントに送信
```

### ゴール時

```
1. MarathonServer: ゴール検出
2. finishTime = tick() - startTime
3. RankingManager.MarkFinished()
4. TimeDataManager.SaveBestTime(player, finishTime)
   - 新記録ならDataStore保存 + ランキング更新
   - 新記録でなければRecordRace()でレース回数のみ更新
5. RaceFinished:FireClient(player, finishTime)
```

---

## 設定一覧 (RaceConfig)

### レース設定
```lua
Race = {
    CountdownTime = 5,      -- カウントダウン時間
    MaxRacers = 30,         -- 最大レーサー数
    MinPlayersToStart = 1,  -- 開始に必要な最小プレイヤー数
    LapCount = 1,           -- 周回数
    FinishWaitTime = 5,     -- ゴール後の待機時間
    DNFTimeLimit = 600      -- 制限時間 (10分)
}
```

### CPU設定
```lua
CPU = {
    Count = 29,             -- CPU数
    LevelRange = {
        Min = 3,
        Max = 5
    }
}
```

### プレイヤー設定
```lua
Player = {
    NormalSpeed = 16,   -- 通常速度
    SpawnRadius = 50    -- スポーン制限半径
}
```

### ブースト設定
```lua
Boost = {
    Speed = 32,  -- ブースト速度
    Duration = {
        Blue = 3,
        Yellow = 5,
        Red = 10
    }
}
```

### チェックポイント設定
```lua
Checkpoint = {
    DetectionRadius = 50,      -- 検出半径
    LookAheadCount = 100,      -- 先読み数
    StuckThreshold = 30,       -- スタック判定閾値
    StuckRecoveryRadius = 150  -- スタック回復半径
}
```

### UI設定
```lua
UI = {
    LeaderboardVisible = true,
    LeaderboardMaxEntries = 10,
    ShowProgress = true,
    ShowMinimap = false
}
```

---

## パフォーマンス最適化

### 削除済み不要スクリプト

| 種類 | 削除数 | 説明 |
|------|--------|------|
| CoreTextureSystem | 732 | 外部モデルのテクスチャスクリプト |
| TextureConfiguration | 732 | 外部モデルの設定スクリプト |
| その他 | 12 | NightLights, 自販機関連等 |
| **合計** | **1476** | |

### 最適化後のスクリプト数

| 種類 | 数 |
|------|-----|
| サーバースクリプト | 6 |
| モジュールスクリプト | 8 |
| ローカルスクリプト | 0 |
| **合計** | **14** |

### 無効化した機能

| 機能 | 理由 |
|------|------|
| TextChatService | ModerationServiceエラー回避 |

---

## 既知の注意点

### プレイヤー進捗検出

プレイヤーは手動操作のため、CPUとは異なる検出ロジックが必要:

- **CPU**: MoveTo でウェイポイント中心に向かうため、8ユニット閾値で十分
- **プレイヤー**: コース端を走る可能性があるため、30ユニット閾値 + 50ウェイポイント先読みが必要

```lua
-- MarathonServer.lua - updatePlayerWaypoint()
local DETECTION_RADIUS = 30   -- コース幅(46)の半分以上
local LOOK_AHEAD_COUNT = 50   -- 複数ウェイポイントを先読み
```

### DataStore制限

- ゲームがPublishされていないとDataStoreは動作しない
- StudioでテストするにはAPIサービスアクセスを有効化する必要がある

### OrderedDataStore順位取得

RobloxのOrderedDataStoreには`GetRankAsync`メソッドが存在しない。プレイヤーの順位を取得するには`GetSortedAsync`でランキング全体を取得し、その中から検索する必要がある：

```lua
-- TimeDataManager.GetPlayerRank()
function TimeDataManager.GetPlayerRank(player)
    local targetKey = "Player_" .. player.UserId

    local success, pages = pcall(function()
        return rankingDataStore:GetSortedAsync(true, 100)
    end)

    if not success or not pages then return nil end

    local rank = 1
    while true do
        local pageData = pages:GetCurrentPage()

        for _, entry in ipairs(pageData) do
            if entry.key == targetKey then
                return rank
            end
            rank = rank + 1
        end

        if pages.IsFinished then break end
        pages:AdvanceToNextPageAsync()
    end

    return nil
end
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-04 | CPU数を28→29に変更 (合計30人) |
| 2026-01-04 | CPUカスタマイズシステム追加 (名前・色・顔) |
| 2026-01-04 | CPU走りアニメーション追加 |
| 2026-01-04 | ベストタイム保存システム (TimeDataManager) 追加 |
| 2026-01-04 | 世界ランキングシステム追加 |
| 2026-01-04 | ランキングUI追加 (ホーム画面RANKINGボタン) |
| 2026-01-04 | 不要スクリプト1476個削除 (パフォーマンス改善) |
| 2026-01-04 | TextChatService無効化 (ModerationServiceエラー対策) |
| 2026-01-04 | 自販機スクリプト・Coin UI削除 |
| 2026-01-04 | プレイヤー順位検出の修正 (検出半径8→30、先読み追加) |
| 2026-01-05 | 難易度選択システム追加 (EASY/NORMAL/HIGH) |
| 2026-01-05 | DifficultyConfig モジュール追加 |
| 2026-01-05 | DifficultySelector LocalScript追加 |
| 2026-01-05 | DifficultySelected BindableEvent追加 |
| 2026-01-05 | CPUManager/MarathonServer 難易度パラメータ対応 |
| 2026-01-05 | 連続プレイ時の状態リセット問題を修正 |
| 2026-01-05 | モバイルUI最適化 (リーダーボードサイズ縮小、タイプアイコン非表示) |
| 2026-01-05 | TimeDataManager GetPlayerRank バグ修正 (GetRankAsync→GetSortedAsync検索方式) |
